#!/bin/bash\n# uDESK role detection system\n# Integrates with TinyCore's user model and boot parameters\n\n# Check for kernel command line role override\nCMDLINE_ROLE=$(grep -o 'udos\\.role=[^ ]*' /proc/cmdline 2>/dev/null | cut -d= -f2)\n\n# Check for persistent role file\nROLE_FILE=\"/etc/udos/role\"\nPERSISTENT_ROLE=\"\"\nif [ -f \"$ROLE_FILE\" ]; then\n    PERSISTENT_ROLE=$(cat \"$ROLE_FILE\" 2>/dev/null | tr -d '\\n\\r')\nfi\n\n# Check current user context for role hints\nCURRENT_USER=$(whoami)\nUSER_ROLE=\"\"\ncase \"$CURRENT_USER\" in\n    \"tc\"|\"udos\")\n        # Standard TinyCore user - check group membership\n        if groups | grep -q \"udos-admin\"; then\n            USER_ROLE=\"admin\"\n        elif groups | grep -q \"udos-standard\"; then\n            USER_ROLE=\"standard\"  \n        else\n            USER_ROLE=\"basic\"\n        fi\n        ;;\n    \"udos-admin\")\n        USER_ROLE=\"admin\"\n        ;;\n    \"root\")\n        USER_ROLE=\"admin\"\n        ;;\n    *)\n        USER_ROLE=\"basic\"\n        ;;\nesac\n\n# Role precedence: cmdline > persistent > user context > default\nif [ -n \"$CMDLINE_ROLE\" ]; then\n    DETECTED_ROLE=\"$CMDLINE_ROLE\"\n    ROLE_SOURCE=\"kernel command line\"\nelif [ -n \"$PERSISTENT_ROLE\" ]; then\n    DETECTED_ROLE=\"$PERSISTENT_ROLE\"\n    ROLE_SOURCE=\"persistent config\"\nelif [ -n \"$USER_ROLE\" ]; then\n    DETECTED_ROLE=\"$USER_ROLE\"\n    ROLE_SOURCE=\"user context\"\nelse\n    DETECTED_ROLE=\"basic\"\n    ROLE_SOURCE=\"default\"\nfi\n\n# Validate role\ncase \"$DETECTED_ROLE\" in\n    \"basic\"|\"standard\"|\"admin\")\n        # Valid role\n        ;;\n    *)\n        echo \"Warning: Invalid role '$DETECTED_ROLE', falling back to basic\" >&2\n        DETECTED_ROLE=\"basic\"\n        ROLE_SOURCE=\"fallback\"\n        ;;\nesac\n\n# Debug output if requested\nif [ \"$1\" = \"--debug\" ] || [ -f \"/etc/udos/debug-mode\" ]; then\n    cat << EOF >&2\nRole Detection Debug:\n- Kernel cmdline: ${CMDLINE_ROLE:-\"(none)\"}\n- Persistent file: ${PERSISTENT_ROLE:-\"(none)\"}\n- User context: ${USER_ROLE:-\"(none)\"}\n- Current user: $CURRENT_USER\n- Groups: $(groups 2>/dev/null || echo \"unknown\")\n- Selected: $DETECTED_ROLE (from $ROLE_SOURCE)\nEOF\nfi\n\n# Output the detected role\necho \"$DETECTED_ROLE\"\n\n# Create/update role marker for other scripts\necho \"$DETECTED_ROLE\" > \"/tmp/udos-current-role\" 2>/dev/null || true\n\n# Log role detection for audit trail\nif [ -w \"/var/log\" ]; then\n    echo \"$(date): Role detected as '$DETECTED_ROLE' from $ROLE_SOURCE\" >> /var/log/udos.log\nfi\n